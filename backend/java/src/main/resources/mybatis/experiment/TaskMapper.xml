<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.TaskMapper">
    <select id="select" resultType="com.ruoyi.experiment.pojo.vo.TaskVO">
        select t.task_id,t.task_name,t.task_status,t.create_user_id as createUserId,te.user_id as executeUserId
        from task t
            inner join task_user tu on t.task_id = tu.task_id
            left outer join task_executor te on t.task_id = te.task_id
        <where>
            t.parent_task_id=#{parentTaskId}
            <if test="userId!=null">and tu.user_id=#{userId}</if>
            <if test="taskName!=null">and t.task_name like concat('%',#{taskName},'%')</if>
            <if test="taskStatus!=null">and t.task_status=#{taskStatus}</if>
            <if test="createTimeStart!=null">and t.create_time &gt;= #{createTimeStart}</if>
            <if test="createTimeEnd!=null">and t.create_time &lt;= #{createTimeEnd}</if>
        </where>
        group by t.task_id,t.task_name,t.task_status,t.create_user_id,te.user_id
        order by
        <if test="orderBy!=null and orderDirection!=null">t.${orderBy} ${orderDirection}</if>
        <if test="orderBy==null or orderDirection==null">t.create_time desc</if>
    </select>

    <select id="selectParentIdsHaveSubTasks" resultType="java.lang.Long">
        select parent_task_id from task
        <where>
            <if test="parentIds!=null and parentIds.size()>0">
                parent_task_id in
                <foreach collection="parentIds" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectCalculatePercentage" resultType="map">
        select count(*) as totalSubTasks,
               sum(case when task_status>=3 then 1 else 0 end) as completedSubTasks
        from task
        where parent_task_id=#{parentTaskId}
    </select>
    <select id="selectTaskDetailVOById" resultType="com.ruoyi.experiment.pojo.vo.TaskDetailVO">
        select t.*,
            su.user_id as executorUserId,
            su.nick_name as executorNickName
        from task t
            left outer join task_executor te on t.task_id = te.task_id
            left outer join sys_user su on te.user_id = su.user_id
        where t.task_id=#{taskId}
    </select>
    <insert id="insertTask" useGeneratedKeys="true" keyProperty="taskId">
        insert into task(parent_task_id, task_name, task_description, task_remark, task_order, task_depth, task_status, create_user_id, create_nick_name, create_time, expected_finish_time, actual_finish_time, update_time)
        VALUES
            (#{parentTaskId},#{taskName},#{taskDescription},#{taskRemark},#{taskOrder},#{taskDepth},#{taskStatus},#{createUserId},#{createNickName},#{createTime},#{expectedFinishTime},#{actualFinishTime},#{updateTime})
    </insert>
    <update id="updateTask">
        update task
        <set>
            <if test="taskName!=null">task_name=#{taskName},</if>
            <if test="taskDescription!=null">task_description=#{taskDescription},</if>
            <if test="taskRemark!=null">task_remark=#{taskRemark},</if>
            <if test="taskStatus!=null">task_status=#{taskStatus},</if>
            <if test="expectedFinishTime!=null">expected_finish_time=#{expectedFinishTime},</if>
            <if test="actualFinishTime!=null">actual_finish_time=#{actualFinishTime},</if>
            <if test="updateTime!=null">update_time=#{updateTime},</if>
        </set>
        where task_id=#{taskId}
    </update>
</mapper>