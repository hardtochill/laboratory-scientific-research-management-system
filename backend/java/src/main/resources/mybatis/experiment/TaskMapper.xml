<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.TaskMapper">

    <select id="selectFirstParentTasks" resultType="com.ruoyi.experiment.pojo.vo.TaskVO">
        select task_id,task_name,task_status from task
        <where>
            parent_task_id=#{parentTaskId} and (execute_user_id=#{userId} or visible_type=1)
        <if test="taskDTO.taskName!=null">and task_name like concat('%',#{taskDTO.taskName},'%')</if>
        <if test="taskDTO.taskStatus!=null">and task_status=#{taskDTO.taskStatus}</if>
        <if test="taskDTO.visibleType!=null">and visible_type=#{taskDTO.visibleType}</if>
        <if test="taskDTO.executeNickName!=null">and execute_nick_name like concat('%',#{taskDTO.executeNickName},'%')</if>
        <if test="taskDTO.createTimeStart!=null">and create_time &gt;= #{taskDTO.createTimeStart}</if>
        <if test="taskDTO.createTimeEnd!=null">and create_time &lt;= #{taskDTO.createTimeEnd}</if>
        </where>
        order by create_time desc
    </select>
    
    <select id="selectSubParentTasks" resultType="com.ruoyi.experiment.pojo.vo.TaskVO">
        select task_id,task_name,task_status from task
        where parent_task_id=#{parentTaskId} and (execute_user_id=#{userId} or visible_type=1)
        order by task_order asc
    </select>

    <select id="selectTaskById" resultType="com.ruoyi.experiment.pojo.entity.Task">
        select * from task
        where task_id = #{taskId}
    </select>

    <select id="selectParentIdsWithSubTasks" resultType="java.lang.Long">
        select parent_task_id from task
        <where>
            <if test="parentIds!=null and parentIds.size()>0">
                parent_task_id in
                <foreach collection="parentIds" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectCalculatePercentage" resultType="map">
        select count(*) as totalSubTasks,
               sum(case when task_status>=2 then 1 else 0 end) as completedSubTasks
        from task
        where parent_task_id=#{parentTaskId}
    </select>
    
</mapper>