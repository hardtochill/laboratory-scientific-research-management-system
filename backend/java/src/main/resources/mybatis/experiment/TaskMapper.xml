<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.TaskMapper">
    <insert id="insertTask" useGeneratedKeys="true" keyProperty="taskId">
        insert into task(parent_task_id, task_name, task_description, task_remark, task_order, task_depth, task_status, create_user_id, create_nick_name, create_time, expected_finish_time, actual_finish_time, update_time)
        VALUES
        (#{parentTaskId},#{taskName},#{taskDescription},#{taskRemark},#{taskOrder},#{taskDepth},#{taskStatus},#{createUserId},#{createNickName},#{createTime},#{expectedFinishTime},#{actualFinishTime},#{updateTime})
    </insert>
    <update id="updateTask">
        update task
        <set>
            <if test="taskName!=null">task_name=#{taskName},</if>
            <if test="taskDescription!=null">task_description=#{taskDescription},</if>
            <if test="taskRemark!=null">task_remark=#{taskRemark},</if>
            <if test="taskStatus!=null">task_status=#{taskStatus},</if>
            <if test="expectedFinishTime!=null">expected_finish_time=#{expectedFinishTime},</if>
            <if test="actualFinishTime!=null">actual_finish_time=#{actualFinishTime},</if>
            <if test="updateTime!=null">update_time=#{updateTime},</if>
        </set>
            where task_id=#{taskId}
    </update>

    <select id="selectFirstParentTasksForTeacher" resultType="com.ruoyi.experiment.pojo.vo.TaskVO">
        select task_id,task_name,task_status from task
        <where>
            parent_task_id=#{parentTaskId}
        <if test="taskQueryDTO.taskName!=null">and task_name like concat('%',#{taskQueryDTO.taskName},'%')</if>
        <if test="taskQueryDTO.taskStatus!=null">and task_status=#{taskQueryDTO.taskStatus}</if>
        <if test="taskQueryDTO.createTimeStart!=null">and create_time &gt;= #{taskQueryDTO.createTimeStart}</if>
        <if test="taskQueryDTO.createTimeEnd!=null">and create_time &lt;= #{taskQueryDTO.createTimeEnd}</if>
        </where>
        order by create_time desc
    </select>
    <select id="selectFirstParentTasksForStudent" resultType="com.ruoyi.experiment.pojo.vo.TaskVO">
        select task.task_id,task_name,task_status from task
        inner join task_user on task.task_id = task_user.task_id
        <where>
            task_user.user_id=#{userId}
            and parent_task_id=#{parentTaskId}
            <if test="taskQueryDTO.taskName!=null">and task_name like concat('%',#{taskQueryDTO.taskName},'%')</if>
            <if test="taskQueryDTO.taskStatus!=null">and task_status=#{taskQueryDTO.taskStatus}</if>
            <if test="taskQueryDTO.createTimeStart!=null">and task.create_time &gt;= #{taskQueryDTO.createTimeStart}</if>
            <if test="taskQueryDTO.createTimeEnd!=null">and task.create_time &lt;= #{taskQueryDTO.createTimeEnd}</if>
        </where>
        order by task.create_time desc
    </select>
    
    <select id="selectParentIdsHaveSubTasks" resultType="java.lang.Long">
        select parent_task_id from task
        <where>
            <if test="parentIds!=null and parentIds.size()>0">
                parent_task_id in
                <foreach collection="parentIds" item="id" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectCalculatePercentage" resultType="map">
        select count(*) as totalSubTasks,
               sum(case when task_status>=3 then 1 else 0 end) as completedSubTasks
        from task
        where parent_task_id=#{parentTaskId}
    </select>

</mapper>