<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.NoteMapper">
    <select id="selectLiteratureNoteList" parameterType="com.ruoyi.experiment.pojo.dto.LiteratureNoteQueryDTO" resultType="com.ruoyi.experiment.pojo.entity.LiteratureNote">
        SELECT id, literature_id, user_id, user_nick_name, note_content, like_count, visible_type, publish_time, create_time, update_time
        FROM literature_note
        <where>
            literature_id = #{literatureId}
        </where>
        <if test="sortField != null and sortField != ''">
            ORDER BY ${sortField} ${sortOrder}
        </if>
        <if test="sortField == null or sortField == ''">
            ORDER BY create_time DESC
        </if>
    </select>
    
    <select id="selectUserLikedNoteIds" parameterType="map" resultType="java.lang.Long">
        SELECT note_id
        FROM literature_note_like
        WHERE user_id = #{userId}
        <if test="noteIds != null and noteIds.size() > 0">
            AND note_id IN
            <foreach item="noteId" collection="noteIds" open="(" separator="," close=")">
                #{noteId}
            </foreach>
        </if>
    </select>
    
    <insert id="addNoteLike" parameterType="map">
        INSERT INTO literature_note_like (user_id, note_id)
        VALUES (#{userId}, #{noteId})
        ON DUPLICATE KEY UPDATE create_time = NOW()
    </insert>
    
    <delete id="deleteNoteLike" parameterType="map">
        DELETE FROM literature_note_like
        WHERE user_id = #{userId} AND note_id = #{noteId}
    </delete>
    
    <update id="updateNoteLikeCount" parameterType="map">
        UPDATE literature_note
        SET like_count = like_count + #{delta}
        WHERE id = #{noteId}
    </update>
</mapper>