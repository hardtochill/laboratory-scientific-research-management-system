<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.LiteratureMapper">
    <insert id="insertLiterature" useGeneratedKeys="true" keyProperty="id">
        insert into literature (title, identifier, authors, journal, publish_time, abstract_text, download_count,
                                teacher_score_avg, teacher_score_count, student_score_avg, student_score_count,
                                final_score,
                                upload_user_id, upload_user_nick_name, upload_time, create_time, update_time)
        values (#{title}, #{identifier}, #{authors}, #{journal}, #{publishTime}, #{abstractText}, #{downloadCount},
                #{teacherScoreAvg}, #{teacherScoreCount}, #{studentScoreAvg}, #{studentScoreCount}, #{finalScore},
                #{uploadUserId}, #{uploadUserNickName}, #{uploadTime}, #{createTime}, #{updateTime})
    </insert>

    <!-- 根据查询条件查询文献列表 -->
    <select id="selectLiteratureList" resultType="com.ruoyi.experiment.pojo.vo.LiteratureVO">
        select literature.id, title, authors, journal, publish_time, download_count, final_score,score,
               group_concat(k.keyword_name order by k.usage_count desc, k.keyword_name asc separator ', ') as keywords
        from literature 
        left join literature_score on literature.id = literature_score.literature_id and #{queryDTO.userId} = literature_score.user_id
        left join literature_keyword lk on literature.id = lk.literature_id
        left join keyword k on lk.keyword_id = k.id
        <where>
            <if test="queryDTO.title != null">
                and title like concat('%', #{queryDTO.title}, '%')
            </if>
            <if test="queryDTO.publishTimeStart != null">
                and publish_time &gt;= #{queryDTO.publishTimeStart}
            </if>
            <if test="queryDTO.publishTimeEnd != null">
                and publish_time &lt;= #{queryDTO.publishTimeEnd}
            </if>
            <if test="queryDTO.keywordIdsSize != null and queryDTO.keywordIdsSize > 0">
                and (
                    select count(distinct lk2.keyword_id)
                    from literature_keyword lk2
                    where lk2.literature_id = literature.id
                    and lk2.keyword_id in
                    <foreach collection="queryDTO.keywordIds" item="keywordId" open="(" close=")" separator=",">
                        #{keywordId}
                    </foreach>
                ) = #{queryDTO.keywordIdsSize}
            </if>
        </where>
        group by literature.id
        <if test="queryDTO.sortField != null and queryDTO.sortOrder != null">
            order by ${queryDTO.sortField} ${queryDTO.sortOrder}
        </if>
        <if test="queryDTO.sortField == null or queryDTO.sortOrder == null">
            order by publish_time desc
        </if>
    </select>

    <!-- 更新文献的教师评分均值和数量 -->
    <update id="updateTeacherScore">
        update literature
        set teacher_score_avg = #{avgScore}, teacher_score_count = #{count}, update_time = now()
        where id = #{literatureId}
    </update>
    
    <!-- 更新文献的学生评分均值和数量 -->
    <update id="updateStudentScore">
        update literature
        set student_score_avg = #{avgScore}, student_score_count = #{count}, update_time = now()
        where id = #{literatureId}
    </update>
    
    <!-- 更新文献的最终得分 -->
    <update id="updateFinalScore">
        update literature
        set final_score = #{finalScore}, update_time = now()
        where id = #{literatureId}
    </update>
    <!-- 更新文献 -->
    <update id="updateLiterature">
        update literature
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="identifier != null">identifier = #{identifier},</if>
            <if test="authors != null">authors = #{authors},</if>
            <if test="journal != null">journal = #{journal},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            <if test="abstractText != null">abstract_text = #{abstractText},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        where id = #{id}
    </update>

    <!-- 查询系统内所有文献的最大下载数 -->
    <select id="selectMaxDownloadCount" resultType="java.lang.Integer">
        select max(download_count) from literature
    </select>

    <!-- 根据文献id查询文献详情 -->
    <select id="selectLiteratureDetail" resultType="com.ruoyi.experiment.pojo.vo.LiteratureDetailVO">
        select id, title, authors, journal, publish_time, abstract_text as abstractText,
               download_count as downloadCount,final_score as finalScore,
               upload_user_id as uploadUserId, upload_user_nick_name as uploadUserNickName,
               upload_time as uploadTime
        from literature
        where id = #{id}
    </select>
    
</mapper>