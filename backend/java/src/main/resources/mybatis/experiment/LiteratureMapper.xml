<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.experiment.mapper.LiteratureMapper">
    
    <!-- 根据查询条件查询文献列表 -->
    <select id="selectLiteratureList" resultType="com.ruoyi.experiment.pojo.vo.LiteratureVO">
        select literature.id, title, authors, journal, publish_time, download_count, final_score,score
        from literature left join literature_score on literature.id = literature_score.literature_id and #{queryDTO.userId} = literature_score.user_id
        <where>
            <if test="queryDTO.title != null">
                and title like concat('%', #{queryDTO.title}, '%')
            </if>
            <if test="queryDTO.publishTimeStart != null">
                and publish_time &gt;= #{queryDTO.publishTimeStart}
            </if>
            <if test="queryDTO.publishTimeEnd != null">
                and publish_time &lt;= #{queryDTO.publishTimeEnd}
            </if>
        </where>
        <if test="queryDTO.sortField != null and queryDTO.sortOrder != null">
            order by ${queryDTO.sortField} ${queryDTO.sortOrder}
        </if>
        <if test="queryDTO.sortField == null or queryDTO.sortOrder == null">
            order by publish_time desc
        </if>
    </select>
    
    <!-- 更新文献的下载数 -->
    <update id="updateDownloadCount">
        update literature set download_count = download_count + 1 where id = #{id}
    </update>
    
    <!-- 插入文献评分记录 -->
    <insert id="insertLiteratureScore">
        insert into literature_score(literature_id, user_id, score, create_time, update_time)
        values(#{literatureId}, #{userId}, #{score}, #{createTime}, #{updateTime})
    </insert>
    
    <!-- 更新文献的评分记录 -->
    <update id="updateLiteratureScore">
        update literature_score
        set score = #{score}, update_time = #{updateTime}
        where literature_id = #{literatureId} and user_id = #{userId}
    </update>
    
    <!-- 更新文献的教师评分均值和数量 -->
    <update id="updateTeacherScore">
        update literature
        set teacher_score_avg = #{avgScore}, teacher_score_count = #{count}, update_time = now()
        where id = #{literatureId}
    </update>
    
    <!-- 更新文献的学生评分均值和数量 -->
    <update id="updateStudentScore">
        update literature
        set student_score_avg = #{avgScore}, student_score_count = #{count}, update_time = now()
        where id = #{literatureId}
    </update>
    
    <!-- 更新文献的最终得分 -->
    <update id="updateFinalScore">
        update literature
        set final_score = #{finalScore}, update_time = now()
        where id = #{literatureId}
    </update>
    
    <!-- 查询系统内所有文献的最大下载数 -->
    <select id="selectMaxDownloadCount" resultType="java.lang.Integer">
        select max(download_count) from literature
    </select>
    
    <!-- 根据文献id列表查询文献信息 -->
    <select id="selectLiteratureByIds" resultType="com.ruoyi.experiment.pojo.entity.Literature">
        select * from literature where id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
    
    <!-- 查询文献的教师评分统计 -->
    <select id="selectTeacherScoreStatistics" resultType="java.util.Map">
        select avg(ls.score) as avgScore, count(ls.id) as count
        from literature_score ls
        inner join sys_user u on ls.user_id = u.user_id
        inner join sys_user_role ur on u.user_id = ur.user_id
        inner join sys_role r on ur.role_id = r.role_id
        where ls.literature_id = #{literatureId} and r.role_name = 'teacher'
    </select>
    
    <!-- 查询文献的学生评分统计 -->
    <select id="selectStudentScoreStatistics" resultType="java.util.Map">
        select avg(ls.score) as avgScore, count(ls.id) as count
        from literature_score ls
        inner join sys_user u on ls.user_id = u.user_id
        inner join sys_user_role ur on u.user_id = ur.user_id
        inner join sys_role r on ur.role_id = r.role_id
        where ls.literature_id = #{literatureId} and r.role_name != 'teacher'
    </select>
</mapper>